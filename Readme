
# LoyApp Referral API – README

This document explains how to use our backend referral API so the Flutter team can integrate referral creation and tracking features into the LoyApp Flutter application.

---

## 1. Base URL

Our Cloud Functions are deployed at:

```
https://us-central1-loyapp-343d9.cloudfunctions.net/api/api
```

All endpoints below are relative to this URL. So, for example, the full path to **create** a referral is:

```
https://us-central1-loyapp-343d9.cloudfunctions.net/api/api/referrals/create
```

---

## 2. Endpoints

Below is a quick reference for each endpoint:

### 1) **Create Referral**

- **Method**: `POST`
- **Path**: `/api/referrals/create`
- **Request Body (JSON)**:

  ```json
  {
    "memberId": "someMemberId",
    "projectId": "project-123",
    "creatorUserId": "UID_of_the_creator" 
  }
  ```
  | Field           | Type     | Required? | Description                                                                |
  |-----------------|----------|-----------|----------------------------------------------------------------------------|
  | `memberId`      | String   | Yes       | The user (member) associated with this referral link                       |
  | `projectId`     | String   | Yes       | The project ID being referred                                             |
  | `creatorUserId` | String   | Yes/No    | The UID of the logged-in user creating the link. Needed if you track who creates it |

- **Success Response** (`201 Created`):
  ```json
  {
    "message": "Referral created successfully.",
    "referralId": "autoGeneratedDocID",
    "referralLink": "https://some-project-link?ref=REF-someMemberId-1689273688834&project=project-123"
  }
  ```
  - `referralLink` is a URL your app or user can share.

### 2) **Track Visit**

- **Method**: `POST`
- **Path**: `/api/referrals/track`
- **Request Body (JSON)**:
  ```json
  {
    "referralCode": "REF-someMemberId-1689273688834"
  }
  ```
  | Field          | Type   | Required? | Description                                                                 |
  |----------------|--------|-----------|-----------------------------------------------------------------------------|
  | `referralCode` | String | Yes       | The unique code embedded in the referral link (e.g., `"REF-..."`). Must match the code in Firestore |

- **Success Response** (`200 OK`):
  ```json
  {
    "message": "Visit tracked successfully.",
    "visitsCount": 5,
    "pointsEarned": 1
  }
  ```
  - `visitsCount` is how many total visits the link has now.
  - `pointsEarned` is how many points were awarded on this visit (if any).

### 3) **Get Referral Info**

- **Method**: `GET`
- **Path**: `/api/referrals/:referralCode`
  - For example: `/api/referrals/REF-someMemberId-1689273688834`
- **Success Response** (`200 OK`):
  ```json
  {
    "id": "theFirestoreDocID",
    "userId": "UID_of_link_creator",
    "memberId": "someMemberId",
    "projectId": "project-123",
    "referralCode": "REF-someMemberId-1689273688834",
    "referralLink": "https://some-project-link?ref=REF-someMemberId-1689273688834&project=project-123",
    "visitsCount": 5,
    "createdAt": { /* Firestore Timestamp */ }
  }
  ```

---

## 3. How to Integrate in Flutter

You can use Dart’s [`http` package](https://pub.dev/packages/http) or [`dio` package](https://pub.dev/packages/dio) to send HTTP requests from Flutter. Below are **examples** with `http`.

### Example 1: Create Referral

```dart
import 'package:http/http.dart' as http;
import 'dart:convert';

Future<void> createReferral(String memberId, String projectId, String creatorUserId) async {
  // Base URL for the deployed function
  final baseUrl = 'https://us-central1-<YOUR_FIREBASE_PROJECT_ID>.cloudfunctions.net/api';

  final url = Uri.parse('$baseUrl/api/referrals/create');
  final response = await http.post(
    url,
    headers: {"Content-Type": "application/json"},
    body: jsonEncode({
      "memberId": memberId,
      "projectId": projectId,
      "creatorUserId": creatorUserId,
    }),
  );

  if (response.statusCode == 201) {
    final data = jsonDecode(response.body);
    print('Referral created: ${data['referralId']}');
    print('Referral link: ${data['referralLink']}');
  } else {
    print('Failed to create referral. Status: ${response.statusCode}');
    print('Response body: ${response.body}');
  }
}
```

### Example 2: Track Visit

```dart
Future<void> trackVisit(String referralCode) async {
  final baseUrl = 'https://us-central1-<YOUR_FIREBASE_PROJECT_ID>.cloudfunctions.net/api';

  final url = Uri.parse('$baseUrl/api/referrals/track');
  final response = await http.post(
    url,
    headers: {"Content-Type": "application/json"},
    body: jsonEncode({"referralCode": referralCode}),
  );

  if (response.statusCode == 200) {
    final data = jsonDecode(response.body);
    print("Visit tracked. visitsCount: ${data['visitsCount']}, pointsEarned: ${data['pointsEarned']}");
  } else {
    print("Error tracking visit. Status: ${response.statusCode}");
    print(response.body);
  }
}
```

### Example 3: Get Referral Info

```dart
Future<void> getReferralInfo(String referralCode) async {
  final baseUrl = 'https://us-central1-<YOUR_FIREBASE_PROJECT_ID>.cloudfunctions.net/api';

  final url = Uri.parse('$baseUrl/api/referrals/$referralCode');
  final response = await http.get(url);

  if (response.statusCode == 200) {
    final data = jsonDecode(response.body);
    print('Referral info: $data');
  } else {
    print('Error getting referral info. Status: ${response.statusCode}');
    print(response.body);
  }
}
```

---

## 4. Error Handling and Edge Cases

- **Missing Fields**: If `memberId` or `projectId` is not passed, `POST /api/referrals/create` returns `400 (Bad Request)`.
- **Referral Not Found**: If `referralCode` doesn’t exist in Firestore, you’ll get `404 (Not Found)`.
- **Internal Server Error**: If something unexpected happens, you’ll get `500 (Internal Server Error)`. Check the response body/logs for more info.

---

## 5. Testing the Endpoints

It’s best to test using Postman, cURL, or any HTTP client before integrating in Flutter:

**Example** (Create a referral):
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"memberId":"testMember","projectId":"proj123","creatorUserId":"theCreatorUID"}' \
  "https://us-central1-<YOUR_FIREBASE_PROJECT_ID>.cloudfunctions.net/api/api/referrals/create"
```

**Track visit**:
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"referralCode":"REF-testMember-1689273688834"}' \
  "https://us-central1-<YOUR_FIREBASE_PROJECT_ID>.cloudfunctions.net/api/api/referrals/track"
```

---

## 6. Contact & Support

- If you have questions about authentication or run into error codes, please let us know.
- Check your Cloud Function logs (via Firebase Console > Functions > Logs) if you get unexpected `500` errors.

---

### Summary

1. **Use** the base URL:
   ```
   https://us-central1-<YOUR_FIREBASE_PROJECT_ID>.cloudfunctions.net/api
   ```
2. **Endpoints**:
   - `POST /api/referrals/create`
   - `POST /api/referrals/track`
   - `GET /api/referrals/:referralCode`
3. **Use** JSON in the request body, and parse JSON from the response.
4. **Test** thoroughly with Postman or cURL, then in Flutter.

